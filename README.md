# Трансформация HTML через XSLT

Модуль позволяет применить XSL-транформации указанным HTML-файлам, даже если это невалидный XML.

В отличие от обычного преобразования, доступного в популярных XSLT-процессорах (например, `libxslt`), даёт следующие преимущества:

* Полноценный Node.JS модуль, который можно встраивать в другие проекты.
* Поддержка [glob-шаблонов](http://man7.org/linux/man-pages/man7/glob.7.html).
* Возможность препроцессинга HTML/XML документов перед XSL-преобразованием.
* Поддержка [XSLT-препроцессора](https://github.inn.ru/template/preprocessor).

## Установка

В консоли выполняем:

```
npm install git+https://github.inn.ru/template/html-transform.git
```

Дополнительно может понадобится установить [некоторые зависимости](https://github.com/bsuh/node_xslt#requirements), необходимые для сборки libxslt-моста. В частности, это понадобится для установки на Linux-сервер.

## Использование

```js
var transformer = require('html-transform');

transformer(xsl, options)
	.use(processor)
	.run(html, options, callback)
```

Методы:

### constructor(files, [options])

Создаёт новый объект трансформатора. Можно создавать через `constructor(...)` либо `new constructor()`.

Аргументы:

* `files` (`Buffer|String|Array`) – XSLT-шаблоны, которые нужно применить файлам .Может быть непосредственно содержимым файла (`Buffer`), путём к файлу с использованием glob-шаблонов (`String`) либо массивом буфферов и/или строк.
* `options` (`Object`) — параметры, которые будет переданы модулю `glob` (в случае, если используем строу или массив строк в аргументе `files`).

### stylesheet(files, [options])

Указывает, какие XSLT-шаблоны будут применяться при трансформации. Автоматически вызывается в конструкторе, аргументы точно такие же.

### use(processor)

Добаваляет процессор, который будет применен к преобразуемым HTML/XML файлам перед тем, как они будут в XSLT-процессор.

#### processor(dom, res, [callback])

* `dom` (`Object`) —  DOM-дерево, полученное модулем [`DomHandler`](https://github.com/fb55/domhandler). Обработчик должен модифицировать само дерево, а не возвращать новое.
* `res` (`Object`) – информация о файле, который сейчас преобразуется.
* `callback` (`Function`) – В случае, если процессор должен работать асинхронно, функция обработчика должна принимать три параметра: третьим будет callback-функция, которую нужно вызвать по завершению работы процессора.

### run(files, [options], callback)

Запускает трансформацию указанных файлов.

Аргументы:

* `files` (`Buffer|String|Array`) — входящие данные для преобразования. Типы данных такие же, как и в конструкторе.
* `options` (`Object`) – параметры для `glob` (см. конструктор)
* `callback(err, result)` (`Function`) — функция, вызываемая после того, как все преобразования завершаться. Первым параметром принимает ошибку (если такая возникла во время преобразования), вторым — массив объектов. Объекты содержат свойства `file` (абсолютный путь к входящему файлу) и `content` (преобразованное содержимое файла).

Более подробные примеры можно [увидеть в тестах](https://github.inn.ru/template/html-transform/blob/master/test/suite.js#L35).